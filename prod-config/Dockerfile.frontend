# Стадия сборки
FROM node:22-bullseye-slim AS build

WORKDIR /usr/app

COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile --production=false

COPY . .
RUN yarn build

# Стадия запуска
FROM node:22-bullseye-slim AS prod

WORKDIR /usr/app

# Объявляем ARG снова для runtime
ARG NUXT_PUBLIC_STRAPI_URL
ARG NUXT_STRAPI_TOKEN

# Устанавливаем переменные окружения для runtime
ENV NODE_ENV=production
ENV HOST=0.0.0.0
ENV PORT=3000
ENV NUXT_PUBLIC_STRAPI_URL=${NUXT_PUBLIC_STRAPI_URL}
ENV NUXT_STRAPI_TOKEN=${NUXT_STRAPI_TOKEN}

# Копируем собранное приложение
COPY --from=build /usr/app/.output ./.output
COPY --from=build /usr/app/package.json ./

# Создаем непривилегированного пользователя
RUN groupadd -g 1001 nodejs && \
    useradd -u 1001 -g nodejs -s /bin/bash -m nodejs && \
    chown -R nodejs:nodejs /usr/app

USER nodejs

EXPOSE 3000

CMD ["node", ".output/server/index.mjs"]